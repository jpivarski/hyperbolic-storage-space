<!DOCTYPE html>
<html>
<meta charset="utf-8">
<script type="text/javascript" src="HyperbolicViewport.js"></script>
<script type="text/javascript">

// var points = "[[-0.5282193335315216, -0.612830109391996], [11.806693582930073, 7.324454155540884], [0.10491842823235767, 0.07224945170684666], [-8.47457085324967, -3.359102014950671], [-0.1228746812089889, -1.719078829675374], [-434.96114504345445, 14.096429352512953], [-1348.2339929795335, 3526.097707760696], [489.9967518047098, -984.1311750917588], [1.1876155697728734, -1.7657347421403045], [2.751706667715291, -0.2819663954026051], [0.20799956997734995, -0.014649370830892497], [-99.15428839294349, 18.51906679014808], [-4.521175229747374, 1.2766789716720188], [-7.525340248212248, 21.426676059036676], [-0.04847651479264875, 0.01631677600688388], [-5.900922532538355, 53.020164760208736], [14.680926511289236, -29.224883547538536], [-0.03845767817306094, -0.032476215781509034], [0.19180759812818926, -0.0837478704539684], [0.14882812617131688, -0.15652211761594884], [-0.054849210697974334, -0.19244133864632096], [-2988.8840348602594, 2334.0395218896615], [0.21576066977305516, -1.7239582156751914], [1.027311768941292, -6.3127946290261985], [4671.380514878892, -13409.914435252964], [330.45194063652593, 638.7164629608516], [3.7413740832747933, 15.796858226030842], [1740.9286847970932, -2350.1911819728207], [-64.5732655248912, 34.847425464383015], [-138.3191092759394, 57.13127682817721], [11563.04757866622, 5432.916909526345], [-1433.8541080858217, -15138.577139111607], [1.3960218167366139, -2.727428696001001], [3186.99005516884, 2389.739695732503], [0.05046995808229509, 0.12507709831507643], [6.70534722309348, 2.5712748853004794], [7.253673687409669, -27.2024250965378], [4140.96274644911, 1038.8292613906347], [-25.362148240839367, 113.02090825608161], [-377.2982626295779, -250.37111395858383], [-11865.690306681174, -6263.087382092868], [-0.5134036264581978, -0.773568564497442], [-3.760952911834107, 2.946414728291653], [-1316.0975126838714, 644.1597502523775], [-0.04377146728582428, 0.04324049255548058], [-130.28766134441307, -3217.330444889548], [-2.2397136730363383, 4.72759465483583], [30.718584267472146, 278.83557096965575], [3.083483055707601, 124.90537956667839], [0.4924917383645819, 0.62744216047561]]";

// function convert([rho, theta, arg]) {
//     return [rho*Math.cos(theta), rho*Math.sin(theta), arg];
// }

// var points = [];
// for (var row = 1;  row < 15;  row++) {
//     var rho1 = Math.LN2*(row - 1);
//     var rho2 = Math.LN2*row;

//     for (var col = 0;  col < (1 << row);  col++) {
//         var theta1 = 2.0*Math.PI*col/(1 << row);
//         var theta2 = 2.0*Math.PI*(col + 1)/(1 << row);

//         points.push(convert([rho1, theta1]));
//         points.push(convert([rho1, theta2]));
//         points.push(convert([rho2, theta2]));

//         if (col > 5) { break; }
//     }
// }
// points = JSON.stringify(points);

// function convert([x, y, arg]) {
//     return [x, y, arg];

//     var r = Math.sqrt(x*x + y*y);
//     var sinhr = 0.5*(Math.exp(r/2.0) - Math.exp(-r/2.0));
//     var coshr = 0.5*(Math.exp(r/2.0) + Math.exp(-r/2.0));

//     if (r == 0.0) {
//         x = 0.0;
//         y = 0.0;
//     }
//     else {
//         x = sinhr*x/r;
//         y = sinhr*y/r;
//     }

//     var preal = x;
//     var pimag = y;
//     var pone = coshr;

//     var Br = 0.9;
//     var Bi = 0.0;

//     var real = -Bi*Bi*preal*pone + 2*Bi*Br*pimag*pone + Br*Br*preal*pone + Br*pimag*pimag + Br*preal*preal + Br*(pimag*pimag + preal*preal + 1.0) + preal*pone;
//     var imag = Bi*Bi*pimag*pone + 2*Bi*Br*preal*pone + Bi*pimag*pimag + Bi*preal*preal + Bi*(pimag*pimag + preal*preal + 1.0) - Br*Br*pimag*pone + pimag*pone;
//     var denom = Bi*Bi*pimag*pimag + Bi*Bi*preal*preal + 2*Bi*pimag*pone + Br*Br*pimag*pimag + Br*Br*preal*preal + 2*Br*preal*pone + pimag*pimag + preal*preal + 1.0;

//     real /= denom;
//     imag /= denom;

//     r = Math.sqrt(real*real, imag*imag);
//     var phi = Math.atan2(imag, real);
//     var arctanhr = 0.5*Math.log((1.0 + r)/(1.0 - r));

//     return [arctanhr*Math.cos(phi), arctanhr*Math.sin(phi), arg];
// }

// var points = JSON.stringify({"fillStyle": "#ffff00", "lineWidth": 1.5, "drawables": [
//     {"type": "polygon", "d": [convert([-1, -1, "LP"]), convert([-1, 1, "LP"]), convert([1, 1, "LP"]), convert([1, -1, "LP"])]},
//     {"type": "polygon", "fillStyle": "rgba(255, 0, 0, 0.5)", "d": [convert([0, 0, "L"]), convert([0, 2, "L"]), convert([2, 2, "L"]), convert([2, 0, "L"])]},
//     {"type": "polygon", "fillStyle": "none", "d": [convert([0, 0, "L"]), convert([0, -2, "L"]), convert([-2, -2, "L"]), convert([-2, 0, "L"])]}
//     ]});

var points = JSON.stringify({"fillStyle": "#ffff00", "lineWidth": 1.5, "drawables": [
    {"type": "polygon", "d": [[0.5, 0.0*Math.PI, "L"], [1.0, 0.1*Math.PI, "L"], [0.5, 0.2*Math.PI, "L"], [1.0, 0.3*Math.PI, "L"], [0.5, 0.4*Math.PI, "L"], [1.0, 0.5*Math.PI, "L"], [0.5, 0.6*Math.PI, "L"], [1.0, 0.7*Math.PI, "L"], [0.5, 0.8*Math.PI, "L"], [1.0, 0.9*Math.PI, "L"], [0.5, 1.0*Math.PI, "L"], [1.0, 1.1*Math.PI, "L"], [0.5, 1.2*Math.PI, "L"], [1.0, 1.3*Math.PI, "L"], [0.5, 1.4*Math.PI, "L"], [1.0, 1.5*Math.PI, "L"], [0.5, 1.6*Math.PI, "L"], [1.0, 1.7*Math.PI, "L"], [0.5, 1.8*Math.PI, "L"], [1.0, 1.9*Math.PI, "L"]]}
    ]});

// var points = [];
// for (var row = 1;  row < 15;  row++) {
//     var rho1 = Math.LN2*(row - 1);
//     var rho2 = Math.LN2*row;

//     for (var col = 0;  col < (1 << row);  col++) {
//         var theta1 = 2.0*Math.PI*col/(1 << row);
//         var theta2 = 2.0*Math.PI*(col + 1)/(1 << row);

//         points.push(convert([rho2, theta1, "pl"]));
//         points.push(convert([rho1, theta1, "pl"]));
//         points.push(convert([rho1, theta2, "p"]));

//         if (col > 3) { break; }
//     }
// }

// var points = JSON.stringify({"fillStyle": "none", "drawables": [
//     {"type": "polygon", "d": points}
//     ]});

function convert(x, y, ell=true) {
    x = parseFloat(x);
    y = parseFloat(y);

    // THIS BLOCK WILL ONLY BE USED TO FIND OUT WHICH TILES TO EXPORT, NOT TO APPLY CORRECTIONS TO THE CLIENT'S OFFSET
    // // apply an offset in the half-plane
    // // this is not correct
    // var Br = 0.0;
    // var Bi = 0.0;
    // var a = 0.9;
    // // var denom = (x*x + y*y)*Br*Br + 2*x*Br*(1 - Bi) + Math.pow(1 - Bi, 2);
    // // [x, y] = [-(-Bi*Bi*x + Bi*Br*y*y + Bi*Br*x*x + Bi*Br + 2*Bi*x + Br*Br*x - Br*y*y - Br*x*x - Br - x)/denom, -(-Bi*Bi*y + 2*Bi*y - Br*Br*y - y)/denom];

    // var p1 = Math.atan2((Bi*Bi + 2*Bi - Br*Br + 1), (2*Bi*Br + 2*Br));
    // var d1 = Bi*Bi*a*a - 2*Bi*Bi*a*Math.sin(p1) + Bi*Bi - 4*Bi*Br*a*Math.cos(p1) + 2*Bi*a*a - 4*Bi*a*Math.sin(p1) + 2*Bi + Br*Br*a*a + 2*Br*Br*a*Math.sin(p1) + Br*Br - 4*Br*a*Math.cos(p1) + a*a - 2*a*Math.sin(p1) + 1;
    // var x1 = (-2*Bi*Bi*a*Math.cos(p1) + 4*Bi*Br*a*Math.sin(p1) + 2*Br*Br*a*Math.cos(p1) - 2*Br*a*a - 2*Br + 2*a*Math.cos(p1))/d1;
    // var y1 = (Bi*Bi*a*a - Bi*Bi + Br*Br*a*a - Br*Br - a*a + 1)/d1;

    // var p2 = Math.atan2(-(Bi*Bi + 2*Bi - Br*Br + 1), -(2*Bi*Br + 2*Br));
    // var d2 = Bi*Bi*a*a - 2*Bi*Bi*a*Math.sin(p2) + Bi*Bi - 4*Bi*Br*a*Math.cos(p2) + 2*Bi*a*a - 4*Bi*a*Math.sin(p2) + 2*Bi + Br*Br*a*a + 2*Br*Br*a*Math.sin(p2) + Br*Br - 4*Br*a*Math.cos(p2) + a*a - 2*a*Math.sin(p2) + 1;
    // var x2 = (-2*Bi*Bi*a*Math.cos(p2) + 4*Bi*Br*a*Math.sin(p2) + 2*Br*Br*a*Math.cos(p2) - 2*Br*a*a - 2*Br + 2*a*Math.cos(p2))/d2;
    // var y2 = (Bi*Bi*a*a - Bi*Bi + Br*Br*a*a - Br*Br - a*a + 1)/d2;

    // var x3 = (x1 + x2)/2.0;
    // var y3 = (y1 + y2)/2.0;

    // [x, y] = [y3*x + x3, y3*y];

    // convert to the disk
    // var denom = x*x + y*y + 2*y + 1;
    // [x, y] = [2*x/denom, (x*x + y*y - 1)/denom];
    // var r = Math.sqrt(x*x + y*y);
    // END OF THIS BLOCK

    // or do it in one step (the algebra simplifies)...
    // var r = Math.sqrt(4*Math.pow(x, 2)/Math.pow(Math.pow(x, 2) + Math.pow(y, 2) + 2*y + 1, 2) + Math.pow(Math.pow(x, 2) + Math.pow(y, 2) - 1, 2)/Math.pow(Math.pow(x, 2) + Math.pow(y, 2) + 2*y + 1, 2));
    var r = Math.sqrt((x*x + y*y - 2*y + 1)/(x*x + y*y + 2*y + 1));
    var eta = 0.5*(Math.log(1 + r) - Math.log(1 - r));

    [x, y] = [2*x, (x*x + y*y - 1)];
    var phi = Math.atan2(y, x);

    if (ell) {
        return [eta, phi, "L"];
    }
    else {
        return [eta, phi];
    }
}

var points = [];
for (var row = -15;  row <= 15;  row++) {
    var size = Math.pow(2, row);

    for (var col = -4;  col <= 4;  col++) {
        if (col == -4) {
            points.push({"type": "polygon", "d": [convert(size*(col), size), convert(size*(col+0.5), size), convert(size*(col+1), size), convert(size*(col+1), 2*size), convert(size*(col), 2*size)]});
        }
        else {
            points.push({"type": "polygon", "d": [convert(size*(col), size), convert(size*(col+0.5), size), convert(size*(col+1), size), convert(size*(col+1), 2*size, ell=false)]});
        }
    }
}


points = JSON.stringify({"fillStyle": "none", "lineWidth": 1.5, "drawables": points});

var hyperbolicMappingService;
var hyperbolicViewport;

function init() {
    hyperbolicMappingService = new HyperbolicMapFromJSON(points);
    hyperbolicViewport = new HyperbolicViewport(hyperbolicMappingService, "hyperbolicViewport", 500, 500);
}

</script>
<body onload="init();">
<div id="hyperbolicViewport" style="margin: 20px;"></div>
</body>
</html>
