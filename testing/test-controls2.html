<!DOCTYPE html>
<html>
<meta charset="utf-8">
<script type="text/javascript">

var canvas;
var ctx;

var points = [[-7.3365921104169445, -1.8835591566147296], [0.3669869533647117, 8.066953875259701], [2.598134481882894, 3.3643569336701806], [3.4839114950251076, -3.0504495497258155], [1.6172915190105916, 0.0028605001901932333], [-5.63558646980478, -6.176561738465673], [-3.5266763313094582, 6.806543214494911], [-0.12488603802747739, -0.059898309404389526], [0.6155307262945475, -0.13801608577046126], [-1.603626121514348, 2.5427450763009163], [0.4456019673713933, 0.11729578803271842], [6.117254927700542, 6.777035838503324], [-1.7538493061107034, -4.9110969869038925], [1.919728792351097, 1.8365143460982027], [-2.7739246328691634, -1.3255499530733412], [3.359892217686548, 2.680779100578259], [0.7518147586621433, -8.674415982895209], [-2.2532153696707207, -0.9691325000026615], [-1.022166944109578, -7.42738000252083], [9.251341074657445, -0.9424803324472439], [-1.7930000118180944, 2.2672761015761025], [-0.06577846735860897, 0.7316856395441271], [1.2361608207064125, -0.5877435073008108], [6.099253819910888, -0.13077470929028168], [1.7657685529369374, 7.451086963959845], [-5.645695457187812, 3.4891758851037826], [0.709617711014099, 3.5432686225017402], [1.6190513393047095, -0.26582330917963604], [-0.5283508029652927, 3.544281651579699], [-2.711446315895112, 1.34317092462493], [-3.120610280716017, 3.2757079314669832], [5.394793030061471, -4.814284307205025], [3.021818806437246, -4.072033829839742], [0.3175555385615459, -2.1515760329085643], [1.1603647816186602, 1.1961292460187831], [-5.749893979561943, -0.1945811978710952], [0.19724949429590882, 0.4517374665146472], [-0.262110730797026, 0.6655146810196705], [0.3322074641127468, -3.1694905636641915], [-2.932530622862241, 5.980521373292967], [-0.9821479242815558, 0.3513273298790394], [1.7749295995225434, -6.455448730904617], [-4.303225499680179, 3.4147173280063674], [1.5795701337063976, 5.687662245554505], [1.3154244932946761, -1.3793160520501178], [0.08858017796058067, -1.1486530715309935], [3.272086330656667, 0.024669208721223666], [-3.6289493059425237, 0.7600057801571793], [2.5505245138458785, -7.858553876706284], [0.026183746612138025, 2.898648896997961], [7.4794198371625695, 1.2131235453899083], [-5.6333157998071055, 0.5835609842706133], [0.2460120979105878, 3.594602655041448], [4.564092753283129, -0.503730866226023], [-5.229530747095522, 6.728838017397358], [3.012758580888312, -1.6274225025056162], [-4.56866507136828, -6.155895506007735], [4.704284790937679, 7.970940730715163], [7.124387264979721, -2.5509041302038957], [7.214829851650222, 0.4483582103792227], [1.1015828780038184, -1.5326533306444472], [-5.38269708680773, 0.961037532409067], [5.417639410186299, 6.594495848727551], [5.500753422595251, 5.602009322663292], [5.455216081111957, -0.7993991712138266], [-7.892794812494362, 2.031675974462969], [1.5173244223622997, 0.9723278607529142], [4.009654040657736, 0.6137238166282947], [-2.7006935341943765, -1.9674733874954944], [-0.6552460272911518, 2.55158078439513], [3.2790546170440162, -2.622960907393839], [4.901856270621122, -2.8715205015534138], [0.643705595709064, -7.197924682048938], [-3.372562951469448, -6.944745133986139], [3.6986398684288884, -0.4762034991665169], [3.2459987991207218, 1.7222804671622194], [3.903365242447444, -3.5215598869166427], [0.850259761001834, -4.343595646969747], [-0.5445419307496911, -2.3477430331166653], [-1.6714408450635037, -6.997636119582774], [-2.0049814086475455, 0.6639395992632129], [-0.7560609142103802, -0.6259949674183658], [-2.519537942989924, 9.402323778781758], [-6.496597006046653, 3.6895338082099864], [-6.674129564869939, -5.128739532926173], [-4.6309896918127516, 5.656021718621023], [-8.959844540645785, 3.4158299376202166], [1.5851510939552989, -1.5861071444488555], [1.660927618304763, -2.098284838599319], [4.907154002078837, -8.286511509503894], [3.042124873362747, 0.3488184070401863], [3.767893599747262, -0.4308249104433609], [-3.4334246411690836, 0.8513622072163096], [1.6908556254949136, -9.423796000843478], [0.09890235606591609, -5.820045278414725], [-0.8182375321381279, -1.6691952917545125], [-9.795291852340005, 1.2391900996310539], [3.5823452684768804, 7.219677744464563], [-8.954655878620642, -4.05179637801424], [0.3479729954150472, -5.20447266498632]];

var mousing = false;
var threshold = 0.9*0.9;

var init1 = [0, 0];
var init2 = [0, 0];

// not so big yet
function add([amag, aphi], [bmag, bphi]) {
    var areal = amag * Math.cos(aphi);
    var aimag = amag * Math.sin(aphi);
    var breal = bmag * Math.cos(bphi);
    var bimag = bmag * Math.sin(bphi);

    var real = areal + breal;
    var imag = aimag + bimag;

    var mag = Math.sqrt(real*real, imag*imag);
    var phi = Math.atan2(imag, real);

    return [mag, phi];
}

function sub([amag, aphi], [bmag, bphi]) {
    var areal = amag * Math.cos(aphi);
    var aimag = amag * Math.sin(aphi);
    var breal = bmag * Math.cos(bphi);
    var bimag = bmag * Math.sin(bphi);

    var real = areal - breal;
    var imag = aimag - bimag;

    var mag = Math.sqrt(real*real, imag*imag);
    var phi = Math.atan2(imag, real);

    return [mag, phi];
}

function mult([amag, aphi], [bmag, bphi]) {
    return [amag * bmag, aphi + bphi];
}

function div([amag, aphi], [bmag, bphi]) {
    return [amag / bmag, aphi - bphi];
}

function conj([amag, aphi]) {
    return [amag, -aphi];
}

// to be replaced by BigComplex
var Bbefore = [0, 0];
var Rbefore = [1, 0];
var Bnow = [0, 0];
var Rnow = [1, 0];

function init() {
    document.onmousedown = function(e) {
	e.preventDefault();
	init1 = [(e.pageX - 250.0)/250.0, (250.0 - e.pageY)/250.0];

	if (init1[0]*init1[0] + init1[1]*init1[1] < threshold) {
	    mousing = true;
	}
    }

    document.onmouseup = function(e) {
	Bbefore = Bnow;
	Rbefore = Rnow;
	mousing = false;
    }
    
    document.onmousemove = function(e) {
	if (mousing) {
	    oneFinger([(e.pageX - 250.0)/250.0, (250.0 - e.pageY)/250.0]);
	}
    }

    canvas = document.getElementById("canvas");
    ctx = canvas.getContext("2d");
    ctx.fillStyle = "#000000";
    draw();
}

function oneFinger([x, y]) {
    if (x*x + y*y < threshold) {
	var Br = (-y*y*init1[0] - x*x*init1[0] + x*init1[1]*init1[1] + x*init1[0]*init1[0] - x + init1[0])/(y*y*init1[1]*init1[1] + y*y*init1[0]*init1[0] + x*x*init1[1]*init1[1] + x*x*init1[0]*init1[0] - 1);
	var Bi = (-y*y*init1[1] + y*init1[1]*init1[1] + y*init1[0]*init1[0] - y - x*x*init1[1] + init1[1])/(y*y*init1[1]*init1[1] + y*y*init1[0]*init1[0] + x*x*init1[1]*init1[1] + x*x*init1[0]*init1[0] - 1);

	var Bdelta = [Math.sqrt(Br*Br + Bi*Bi), Math.atan2(Bi, Br)];

	Bnow = div(add(Bdelta, mult(Rbefore, Bbefore)),
		   add(mult(Bdelta, conj(Bbefore)), Rbefore));

	Rnow = div(add(Rbefore, mult(Bdelta, conj(Bbefore))),
		   add(mult(Rbefore, mult(conj(Bdelta), Bbefore)), [1, 0]));

	Rnow[0] = 1;

	draw();
    }
}

// to be replaced by a BigComplex calculation
function calculate_F([Pr, Pi]) {
    var pone = Math.sqrt(Pr*Pr + Pi*Pi + 1.0) + 1.0;

    var BrNow = Bnow[0] * Math.cos(Bnow[1]);
    var BiNow = Bnow[0] * Math.sin(Bnow[1]);

    var RrNow = Rnow[0] * Math.cos(Rnow[1]);
    var RiNow = Rnow[0] * Math.sin(Rnow[1]);

    var alpha = Pr + BrNow*pone;
    var beta = Pi + BiNow*pone;
    var gamma = BrNow*Pr + BiNow*Pi + pone;
    var delta = BrNow*Pi - BiNow*Pr;

    var factor = 1.0/(gamma*gamma + delta*delta);

    var resultR = factor*(alpha*gamma + beta*delta);
    var resultI = factor*(beta*gamma - alpha*delta);

    return [RrNow*resultR - RiNow*resultI, RrNow*resultI + RiNow*resultR];
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.beginPath();
    ctx.arc(250, 250, 240, 0, 2*Math.PI);
    ctx.stroke();

    for (var i in points) {
	var x, y;
	[x, y] = calculate_F(points[i]);
	ctx.beginPath();
	ctx.arc(x*240 + 250, -y*240 + 250, 3, 0, 2*Math.PI);
	ctx.fill();
    }
}


</script>
<body onload="init();">
<canvas id="canvas" width="500" height="500"></canvas>
</body>
</html>
